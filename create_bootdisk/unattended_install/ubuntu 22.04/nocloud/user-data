#cloud-config
# https://ubuntu.com/server/docs/install/autoinstall-reference
autoinstall:
  version: 1

  reporting:
    builtin:
      type: print

  apt:
    preserve_sources_list: false
    primary:
        - arches: [default]
          uri: "file:///cdrom/local_repo/archives"

  storage:
    layout:
      name: direct

  ssh:
    allow-pw: true
    install-server: true

  packages:
    - wireguard
    - git
    - qemu-kvm
    - libvirt-daemon
    - libvirt-clients
    - bridge-utils
    - cockpit
    - cockpit-machines
    - i2c-tools

  early-commands:
    - apt update
    - apt -y install i2c-tools
    - /cdrom/ncubed/bin/led blue

  late-commands:
    - /cdrom/ncubed/bin/led orange
    - mkdir /target/opt/ncubed
    - cp -r /cdrom/ncubed /target/opt
    - /cdrom/ncubed/bin/sync-images sdb2 /target/opt/ncubed
    - efibootmgr -n 0000

  error-commands:
    - /cdrom/ncubed/bin/led red

  # cloud-init
  user-data:
    timezone: Europe/Amsterdam
    locale: en_US.UTF-8
    keyboard:
      layout: us
    hostname: netcube01
    package_update: false
    package_upgrade: false
    ssh_pwauth: True
    users:
      - name: nc-admin
        shell: /bin/bash
        sudo: ['ALL=(ALL) NOPASSWD:ALL']
        passwd: $6$e8jD6FuUr$zvHJXNAsAJJKBOqnqrjQ/NnwrZRO28uV/DsEWZOckyFQc4sfb3WpPbEI4oCt9MPCC4Ge6aQ6yiv7/6kpNUb7o0
        lock_passwd: false
    bootcmd:
      - efibootmgr -O
    runcmd:
      - latest=$(ls -d /opt/ncubed/updates/*/ | tail -n1)
      - /bin/bash -c $latest/install.sh
